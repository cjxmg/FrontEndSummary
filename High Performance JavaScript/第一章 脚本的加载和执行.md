高性能JavaScript实践总结
=====================

本总结是对《高性能JavaScript》这本书的总结也是记录笔记,加深我对JavaScript的认识及实践技巧。

## 一、脚本的加载和执行

一般来说，JavaScript代码的执行会阻塞浏览器进行的其他程序，比如用户界面绘制。每次遇到```<script>```后，,页面都必须停下来等待代码下载并执行，然后再继续解析和渲染页面。在这期间，页面渲染和用户交互是完全被阻塞的，例如页面出现长时间的白屏。解决方案如下：  

1. 将```<script>```放在```</body>```之前，确保脚被执行前页面已完成渲染。
2. ```<script>```标签越少越好，可以考虑用gulp任务合并。因为HTTP请求会带来额外的性能开销。
3. 内嵌脚本如果在```<link>```之后会导致页面阻塞去等待样式表的下载。这样能获得最精准的样式信息，但是会阻塞其他任务。（不建议，但hack除外）
3. 使用无阻塞下载的方式
	* **延迟脚本：**   
		在```<script>```标签中使用defer属性，该属性指明此脚本不会修改DOM，因此可以安全的延迟执行。（async属性也用于异步加载脚本，区别在于其加载完成后自动执行，而defer需要页面完成后才执行）
	* **使用XHR对象下载JavaScript代码并注入到页面中**  
		主要的局限是只能在同域中请求js文件，也不能从CDN获取js文件。
	* **动态脚本（推荐）：**  
		 动态创建```<script>```元素并下载执行。即在window对象的load事件出发后再下载脚本。  
		 可自己实现(如下)，也可使用类库:[lazyload](http://github.com/rgrove/lazyload/)、[LABjs](http://labjs.com)。
		 
```
/**
 * @title: addTags动态加载js标签
 * @params:
 * tagUrl: js资源的数组
 * eachLoadedCB: 每个资源加载完毕的回调
 * allLoadedCB: 所有资源加载完毕的回调
 * */
function addTags(tagUrl, eachLoadedCB, allLoadedCB) {

    if (!(tagUrl instanceof Array)) {
        alert("first arguments must be array of urls");
        return false;
    }
    var totalResource = tagUrl.length;
    var restResource = totalResource;
    var downLoadPercent;
    for (var i = 0, len = tagUrl.length; len > i; i++) {
        //标签对象
        var _TagObjs;
        if (/.js$/.test(tagUrl[i])) {
            _TagObjs = document.createElement("script");
            _TagObjs.setAttribute('type', 'text/javascript');
            _TagObjs.setAttribute('src', tagUrl[i]);
            head.appendChild(_TagObjs);
        }
        if(_TagObjs.readyState){
            //IE
            _TagObjs.onreadystatechange = function () {
                if(_TagObjs.readyState == "loaded" || _TagObjs.readyState == "complete"){
                    _TagObjs.onreadystatechange = null;
                    restResource--;
                    downLoadPercent = Math.round((totalResource - restResource) / totalResource * 100);
                    !!eachLoadedCB && eachLoadedCB(totalResource, restResource, downLoadPercent);
                    !!!restResource && allLoadedCB && allLoadedCB();
                }
            }
        }else{
            _TagObjs.onload = function () {
                restResource--;
                downLoadPercent = Math.round((totalResource - restResource) / totalResource * 100);
                !!eachLoadedCB && eachLoadedCB(totalResource, restResource, downLoadPercent);
                !!!restResource && allLoadedCB && allLoadedCB();
            };
        }

    }
}


/**
 * 使用
 * */
addTags(["core.js","lib.js"],function (t,r,d) {
    alert("total:"+t+",rest:"+r+",percent:"+d);
},function () {
    alert("all loaded")
})
```	 		 		 
		 


